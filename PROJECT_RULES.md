# Gaming Cafe Management System — Project Rules & Design Tenets

> **Purpose:** These rules govern every code contribution to this project.
> Any change that violates a rule must be rejected.
> These rules are derived directly from the Failure Modes document.

---

## Rule 1 — Never Allow Free Play

**Tenet:** No code path may allow a user to use a gaming station without an
active, billable session being recorded.

- Every game launch MUST be preceded by a validated session
- Playnite MUST NOT start unless `_currentSession != null`
- The station agent MUST end the session when Playnite exits (process watchdog)
- Failure modes addressed: B-01, B-03, G-03, S-08

---

## Rule 2 — Billing Always Rounds Up

**Tenet:** When billing by the hour, fractional hours MUST round up (ceiling), never down.

- Use `Math.Ceiling(durationMinutes / 60m)` — never floor or truncate
- Per-minute billing uses exact decimal calculation
- Zero-duration sessions bill $0.00 (no negative values)
- Failure modes addressed: B-02, B-05

---

## Rule 3 — UTC Everywhere

**Tenet:** All timestamps MUST be stored and compared in UTC.

- No `DateTime.Now` — always use `DateTime.UtcNow`
- All database columns are UTC; convert to local time only at the display layer
- Station PCs must have NTP sync enabled
- Failure modes addressed: B-05, ST-05

---

## Rule 4 — Passwords Are Never Stored Plaintext

**Tenet:** User passwords MUST be hashed with PBKDF2-SHA256 (minimum 10,000 iterations)
with a cryptographically random per-user salt.

- Use `PasswordHasher` — never roll custom hashing
- The hash format is `iterations.salt.hash` (3-part dot-separated)
- Passwords are compared with constant-time comparison to prevent timing attacks
- Failure modes addressed: S-01

---

## Rule 5 — No Raw SQL

**Tenet:** All database access MUST go through EF Core with parameterized queries.

- No `DbContext.Database.ExecuteSqlRaw()` with user-supplied strings
- No string-concatenated queries
- Migrations MUST be generated by EF Core tooling, not hand-written SQL
- Failure modes addressed: S-05

---

## Rule 6 — Async UI — Never Block the UI Thread

**Tenet:** All I/O (network, disk, auth) MUST be performed asynchronously.
The WinForms UI thread must never be blocked.

- All service calls use `async/await`
- Never `.Wait()` or `.Result` on a Task from the UI thread
- UI updates from background threads use `this.Invoke()`
- Failure modes addressed: U-03

---

## Rule 7 — Single Active Session Per Station

**Tenet:** A station MUST NOT allow more than one active session at a time.

- `CreateSessionAsync` checks for an existing active session before creating one
- Login screen MUST NOT appear while a session is active
- Session cleanup MUST happen before returning to the login screen
- Failure modes addressed: ST-04

---

## Rule 8 — Fail Fast on Startup

**Tenet:** The application MUST validate all critical dependencies at startup
and exit with a clear error message if any are missing.

- Check: Playnite installed at expected path
- Check: Database migrations applied
- Check: Management Server reachable (station agent)
- Check: Billing rates configured (minimum rate > $0)
- Failure modes addressed: D-03, G-01, B-07

---

## Rule 9 — No Secrets in Source Control

**Tenet:** API keys, passwords, connection strings, and tokens MUST NEVER be
committed to the repository.

- Use environment variables or a secrets manager for all credentials
- `.gitignore` MUST include `appsettings.Development.json`, `*.pfx`, `*.key`
- CI secrets are stored in GitHub Actions secrets, never in workflow YAML
- Failure modes addressed: S-06

---

## Rule 10 — HTTPS in Production

**Tenet:** The Management Server MUST enforce HTTPS in production.
HTTP must redirect to HTTPS or be disabled.

- Development may use HTTP for convenience
- Production `appsettings.Production.json` MUST configure HTTPS only
- TLS certificate renewal must be automated
- Failure modes addressed: O-01

---

## Rule 11 — All Behaviour Covered by Tests

**Tenet:** Every user-facing behaviour MUST be described in a Cucumber `.feature`
file and backed by a passing step definition.

- Feature files live in `bdd-tests/features/`
- Step definitions live in `bdd-tests/steps/`
- Unit tests cover service-layer logic
- Playwright tests cover web UI flows
- No feature ships without a corresponding scenario
- Failure modes addressed: O-05

---

## Rule 12 — Accessible UI (WCAG 2.0 AA)

**Tenet:** All user interfaces MUST meet WCAG 2.0 Level AA (ISO/IEC 40500:2012).

- Minimum contrast ratio 4.5:1 for normal text, 3:1 for large text
- All interactive elements are keyboard-navigable
- All images have alt text
- Form fields have associated labels
- Error messages are descriptive and not colour-only
- Failure modes addressed: U-04

---

## Rule 13 — Structured Logging

**Tenet:** All errors and significant events MUST be logged using structured logging (NLog).
Stack traces MUST NOT be shown to end users.

- Use log levels: Trace, Debug, Info, Warn, Error, Fatal
- User-facing error messages are generic; details are in logs only
- Retain logs for minimum 30 days
- Failure modes addressed: U-05, O-03

---

## Rule 14 — Idempotent Payments

**Tenet:** Every payment transaction MUST use an idempotency key to prevent
double-charging on retry.

- Generate a `GUID` idempotency key per transaction before calling the payment API
- Store the key alongside the transaction record
- Retry logic checks for existing successful transaction before re-attempting
- Failure modes addressed: B-06

---

## Rule 15 — CI Must Pass Before Merge

**Tenet:** No code may be merged to `main` without all CI checks passing.

- GitHub Actions pipeline: build → unit tests → BDD tests → Playwright tests
- Branch protection rule enforced on `main`
- No direct pushes to `main`
- Failure modes addressed: O-05

---

## Checklist for New Features

Before any new feature is merged, the author MUST confirm:

- [ ] Does this feature introduce a new failure mode? If so, it is documented in `FAILURE_MODES.md`
- [ ] Does this feature violate any rule above? If so, it must be redesigned
- [ ] Is the feature described in a Cucumber `.feature` file?
- [ ] Are unit tests written for all new service methods?
- [ ] Are Playwright tests written if the feature touches the web UI?
- [ ] Does the UI meet WCAG 2.0 AA contrast and keyboard navigation requirements?
- [ ] Are no secrets introduced into the codebase?
- [ ] Does the feature use UTC for all timestamps?
